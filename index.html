<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Painel de LOCALIZADOR DE M√ÅQUINAS</title>
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üèóÔ∏è</text></svg>">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 85vh; width: 100%; }
    .leaflet-popup-content-wrapper { border-radius: 0.75rem; }
    .leaflet-popup-content { font-size: 1rem; }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-700 via-purple-700 to-violet-800 min-h-screen">
  <nav class="bg-white/90 shadow-lg mb-5 flex items-center justify-between px-6 py-3">
  
  </nav>

  <main class="mx-auto px-4 w-full">
    <section class="mb-7 flex flex-col md:flex-row gap-4 items-center justify-between">
      <h1 class="text-3xl md:text-4xl font-extrabold text-white mb-3 md:mb-0 drop-shadow-lg">
        LOCALIZADOR DE M√ÅQUINAS
      </h1>
      
      <div class="flex flex-wrap gap-4 items-center justify-end">
      
        <button id="atualizarBtn"
          class="bg-white hover:bg-indigo-100 text-indigo-700 font-bold py-2 px-5 rounded-lg shadow transition-all">
          Atualizar Dados
        </button>

        <div class="relative">
          <button id="togglePontosMenuBtn"
            class="bg-white hover:bg-indigo-100 text-indigo-700 font-bold py-2 px-5 rounded-lg shadow transition-all flex items-center gap-2">
            <span>Pontos no Mapa</span>
            <span id="menuPontosChevron" class="transform transition-transform">‚ñº</span>
          </button>
          
          <div id="menuPontosContainer" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-xl z-10 overflow-hidden">
            <div class="p-3 bg-gray-50 border-b border-gray-200">
              <h3 class="font-bold text-gray-800">Todos os Pontos</h3>
            </div>
            <div class="max-h-96 overflow-y-auto">
              <table class="w-full text-sm">
                <tbody id="listaTodosPontos">
                  <tr><td class="p-3 text-gray-500">Carregando...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <div class="relative">
          <button id="toggleIconesMenuBtn" class="bg-white hover:bg-indigo-100 text-indigo-700 font-bold py-2 px-5 rounded-lg shadow transition-all flex items-center gap-2">
            <span>Gerenciar √çcones</span>
            <span id="menuIconeChevron" class="transform transition-transform">‚ñº</span>
          </button>
          <div id="menuIconesContainer" class="hidden absolute right-0 mt-2 w-96 bg-white rounded-lg shadow-xl z-10 p-4">
             <div id="crudIcones" class="bg-white rounded-lg"> 
	            <div class="bg-white rounded-xl shadow px-4 py-3 mb-4">
	              <h3 id="formIconeTitulo" class="text-lg font-bold text-indigo-700 mb-2">Cadastrar Novo √çcone</h3>
	              <form id="cadastroIconeForm" class="flex flex-col gap-3">
	                <input type="hidden" id="editIconeId" name="editIconeId" />
	                <div>
	                  <label for="nomeIcone" class="block text-xs font-semibold text-gray-700 mb-1">Nome:</label>
	                  <input type="text" id="nomeIcone" name="nomeIcone" required class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" />
	                </div>
	                <div>
	                  <label for="urlIcone" class="block text-xs font-semibold text-gray-700 mb-1">URL P√∫blica do √çcone (do Supabase Storage):</label>
	                  <input type="text" id="urlIcone" name="urlIcone" required class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="https://...supabase.co/.../icone.png" />
	                </div>
	                <button type="submit" class="bg-indigo-700 text-white font-bold py-1 px-4 rounded shadow hover:bg-indigo-800 transition" id="submitIconeBtn">Cadastrar √çcone</button>
	                <button type="button" class="bg-gray-500 text-white font-bold py-1 px-4 rounded shadow hover:bg-gray-600 transition hidden" id="cancelEditIconeBtn">Cancelar Edi√ß√£o</button>
	                <p id="mensagemCadastroIcone" class="mt-1 text-xs"></p>
	              </form>
	            </div>
	            <ul id="listaIcones" class="flex flex-wrap gap-2 mb-4">
	              </ul>
	          </div>
          </div>
        </div>

        <div class="relative">
          <button id="toggleCadastroMenuBtn" class="bg-white hover:bg-indigo-100 text-indigo-700 font-bold py-2 px-5 rounded-lg shadow transition-all flex items-center gap-2">
            <span id="tituloMenuCadastro">Cadastrar Novo Celular</span>
            <span id="menuCadastroChevron" class="transform transition-transform">‚ñº</span>
          </button>
          <div id="menuCadastroContainer" class="hidden absolute right-0 mt-2 w-96 bg-white rounded-lg shadow-xl z-10 p-4">
            <div class="bg-white rounded-xl shadow-inner px-4 py-3">
              <form id="cadastroForm" class="flex flex-col gap-3">
                <input type="hidden" id="editId" name="editId" />
                <div>
                  <label for="nome" class="block text-xs font-semibold text-gray-700 mb-1">Nome:</label>
                  <input type="text" id="nome" name="nome" required class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                </div>
                <div>
                  <label for="numero" class="block text-xs font-semibold text-gray-700 mb-1">N√∫mero do celular:</label>
                  <input type="text" id="numero" name="numero" required class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                </div>
                <div>
                  <label for="icone_maquina" class="block text-xs font-semibold text-gray-700 mb-1">√çcone:</label>
                  <select id="icone_maquina" name="icone_maquina" class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </select>
                </div>
                <button type="submit" class="bg-indigo-700 text-white font-bold py-1 px-4 rounded shadow hover:bg-indigo-800 transition" id="submitBtn">Cadastrar</button>
                <button type="button" class="bg-gray-500 text-white font-bold py-1 px-4 rounded shadow hover:bg-gray-600 transition hidden" id="cancelEditBtn">Cancelar</button>
                <p id="mensagemCadastro" class="mt-1 text-xs"></p>
              </form>
            </div>
          </div>
        </div>

      </div>
    </section>
    <div class="bg-white/90 rounded-2xl shadow-lg p-2 mb-4 h-full flex flex-col md:flex-row gap-5">
      <div class="flex-1 min-w-0">
        <div id="map" class="rounded-2xl overflow-hidden shadow-lg"></div>
      </div>
          <div class="md:w-96 flex flex-col gap-5 justify-between">
	        
            <div>
	          <h2 class="text-xl text-indigo-700 font-bold mb-2">Celulares cadastrados</h2>
	          <ul id="listaCelulares" class="flex-1 space-y-2"></ul>
	        </div>
            
            <div>
              <h2 class="text-xl text-indigo-700 font-bold mb-2">Hist√≥rico de Trajeto</h2>
              
              <div class="flex gap-2 items-center mb-2">
                <label for="dataTrajeto" class="text-sm font-medium text-gray-700">Filtrar por Dia:</label>
                <input type="date" id="dataTrajeto" class="p-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>

              <div id="historicoContainer" class="bg-indigo-50 rounded-lg shadow-inner border-l-4 border-indigo-500 p-3 max-h-60 overflow-y-auto">
                  <p id="historicoStatus" class="text-gray-500">Selecione "Trajeto" de um celular para ver o hist√≥rico.</p>
                  <table id="historicoTabela" class="min-w-full text-sm hidden">
                      <thead class="border-b-2 border-indigo-200">
                          <tr>
                              <th class="text-left font-semibold p-1">Data/Hora</th>
                              <th class="text-left font-semibold p-1">Coords</th>
                          </tr>
                      </thead>
                <tbody id="historicoLista"></tbody>
              </table>

              <div id="historicoTotalKm" class="hidden text-right font-bold text-indigo-700 text-lg p-2 mt-2 border-t border-indigo-200">
                  </div>

          </div>
        </div>
    </div>
   
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Troque pelos seus dados!
    const SUPABASE_URL = 'https://rptxfjlxymfmxucctuhc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwdHhmamx4eW1mbXh1Y2N0dWhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NTcxNjMsImV4cCI6MjA3NzEzMzE2M30.kQSF0jp_-0Qi2AmHQNKz6eTo7zeEi3b7Lk9UjT216dU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const apiKey = "9452fa947c234c90b794bf2d1b8c5eb4"; // Geoapify para Leaflet
    const map = L.map('map').setView([-14.2, -51.9], 4);
    
    let polylineLayer = null; // Guarda a linha do trajeto no mapa

    // ================== NOVO: GERENCIADOR DE DROPDOWN (para o cabe√ßalho) ==================
    const dropdowns = [
        { btnId: 'togglePontosMenuBtn',   containerId: 'menuPontosContainer',   chevronId: 'menuPontosChevron' },
        { btnId: 'toggleIconesMenuBtn',   containerId: 'menuIconesContainer',   chevronId: 'menuIconeChevron' },
        { btnId: 'toggleCadastroMenuBtn', containerId: 'menuCadastroContainer', chevronId: 'menuCadastroChevron' }
    ];

    function closeAllDropdowns() {
        dropdowns.forEach(d => {
            document.getElementById(d.containerId).classList.add('hidden');
            const chevron = document.getElementById(d.chevronId);
            if (chevron) chevron.textContent = '‚ñº';
        });
    }

    function openDropdown(containerId, chevronId) {
        closeAllDropdowns();
        document.getElementById(containerId).classList.remove('hidden');
        const chevron = document.getElementById(chevronId);
        if (chevron) chevron.textContent = '‚ñ≤';
    }
    
    function toggleDropdown(containerId, chevronId) {
        const container = document.getElementById(containerId);
        const chevron = document.getElementById(chevronId);
        const isHidden = container.classList.contains('hidden');

        closeAllDropdowns(); // Fecha todos os outros

        if (isHidden) {
            container.classList.remove('hidden');
            if (chevron) chevron.textContent = '‚ñ≤';
        } else {
            container.classList.add('hidden');
            if (chevron) chevron.textContent = '‚ñº';
        }
    }
    // ================== FIM DO GERENCIADOR ==================

    // 1. Defina as duas camadas de mapa (Layers)
    const osmLibertyLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
      maxZoom: 19,
    });
    
    // [SOLU√á√ÉO FINAL - Sat√©lite Gratuito da Esri]
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles ¬© Esri ‚Äî Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
      maxZoom: 19
    });

    // 2. Adicione a camada que voc√™ quer que seja a padr√£o
    osmLibertyLayer.addTo(map);

    // 3. Crie o objeto com as camadas base para o controle
    const baseMaps = {
      "Mapa (Padr√£o)": osmLibertyLayer,
      "Sat√©lite": satelliteLayer 
    };

    // 4. Adicione o controle de camadas ao mapa
    L.control.layers(baseMaps).addTo(map);

    // --- 2. NOVO: FUN√á√ïES DE COMPARTILHAMENTO E DELE√á√ÉO DO POPUP ---

    // Fun√ß√£o para o bot√£o "Copiar" (ATUALIZADA)
    function copiarCoords(lat, lng) {
      const googleMapsLink = `http://googleusercontent.com/maps/google.com/0{lat},${lng}`;
      navigator.clipboard.writeText(googleMapsLink).then(() => {
        alert('Link do Google Maps copiado!');
      }, () => {
        alert('Falha ao copiar o link.');
      });
    }

    // Fun√ß√£o para o bot√£o "WhatsApp" (CORRIGIDA)
    function shareWhatsApp(nome, lat, lng) {
      const googleMapsLink = `http://googleusercontent.com/maps/google.com/0{lat},${lng}`;
      const texto = `Localiza√ß√£o para *${nome}*:\n${googleMapsLink}`;
      
      const whatsappLink = `https://api.whatsapp.com/send?text=${encodeURIComponent(texto)}`;
      window.open(whatsappLink, '_blank');
    }

    // Fun√ß√£o para o bot√£o "Excluir" (NOVA)
    async function deletarPonto(id) {
      if (!confirm('Tem certeza que deseja excluir este Ponto de Interesse?')) return;

      const { error } = await supabase
        .from('usuarios_localizacao')
        .delete()
        .eq('id', id);

      if (error) {
        alert("Erro ao excluir o ponto: " + error.message);
      } else {
        alert("Ponto exclu√≠do com sucesso!");
        map.closePopup(); // Fecha o popup aberto
        buscarCelulares(); // Recarrega os dados do mapa
      }
    }


    // --- 3. MODIFICADO: Fun√ß√£o buscarCelulares atualizada ---
    async function buscarCelulares() {
      const { data: lista, error } = await supabase
        .from('usuarios_localizacao')
        .select('*'); 
      if (error) {
        document.getElementById('listaCelulares').innerHTML = '<li class="text-red-500">Erro ao buscar dados</li>';
        return;
      }

      if (window.markers) window.markers.forEach(m => map.removeLayer(m));
      window.markers = [];
      document.getElementById('listaCelulares').innerHTML = '';

      const listaTodosPontosEl = document.getElementById('listaTodosPontos');
      if (listaTodosPontosEl) {
          listaTodosPontosEl.innerHTML = '';
      }

      (lista || []).filter(c => c.latitude && c.longitude).forEach(({ id, nome, numero, latitude, longitude, created_at, icone_maquina }) => {
        
        // --- L√≥gica de √çcone ---
        const isPontoMarcado = !numero;
        
        let iconUrl;
        let iconSize;
        let iconAnchor;
        let popupAnchor;
        let shadowUrl = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png'; // Sombra padr√£o
        let shadowSize = [41, 41];
        let shadowAnchor = [12, 41];
        
        if (isPontoMarcado) {
            // √â um Ponto de Interesse (Pino Vermelho) - USANDO URL P√öBLICA
            iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png';
            iconSize = [25, 41];    // Tamanho real do √≠cone
            iconAnchor = [12, 41];   // Ponto inferior central
            popupAnchor = [1, -34];  // Ponto de popup
        
        } else if (icone_maquina && icone_maquina.startsWith('http')) {
            // √â uma M√°quina/Celular com √çcone Customizado (URL do Supabase) - TAMANHO QUADRADO
            iconUrl = icone_maquina; // Usa a URL completa vinda do banco
            iconSize = [40, 40];      // Tamanho quadrado (40x40)
            iconAnchor = [20, 40];    // Metade da largura, altura total
            popupAnchor = [0, -40];   // Para o popup sair de cima
            shadowUrl = null; // √çcones customizados geralmente n√£o precisam de sombra
        
        } else {
            // √â uma M√°quina/Celular Padr√£o (√çcone Roxo 'mobile-alt') - Geoapify
            iconUrl = `https://api.geoapify.com/v1/icon/?type=fontawesome&color=%23631fc9&size=large&icon=mobile-alt&apiKey=${apiKey}`;
            iconSize = [38, 58];
            iconAnchor = [19, 56];
            popupAnchor = [0, -50];
            shadowUrl = null; // Geoapify j√° embute a sombra
        }

        const iconOptions = {
          iconUrl: iconUrl,
          iconSize: iconSize, 
          iconAnchor: iconAnchor,
          popupAnchor: popupAnchor,
        };

        if (shadowUrl) {
            iconOptions.shadowUrl = shadowUrl;
            iconOptions.shadowSize = shadowSize;
            iconOptions.shadowAnchor = shadowAnchor;
        }

        const markerIcon = L.icon(iconOptions);
        // --- Fim da L√≥gica de √çcone ---

        // --- L√≥gica de Popup atualizada ---
        const texto = `
          <div class="text-indigo-700 font-bold text-lg mb-1">${nome}</div>
          ${numero ? 
            `<div class="font-medium text-gray-600">Celular: <span>${numero}</span></div>` : 
            '<div class="font-medium text-gray-600">Ponto de Interesse</div>'
          }
          <div class="text-xs text-gray-600 mt-1">Registrado: ${created_at ? new Date(created_at).toLocaleString('pt-BR') : '---'}</div>
          <div class="text-xs text-gray-600">Lat: ${latitude?.toFixed(6)}, Lng: ${longitude?.toFixed(6)}</div>
          
          <div class="mt-3 flex flex-wrap gap-2">
            <button onclick="copiarCoords(${latitude}, ${longitude})" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-2 rounded transition-all">Copiar</button>
            <button onclick="shareWhatsApp('${nome.replace(/'/g, "\\'")}', ${latitude}, ${longitude})" class="bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-2 rounded transition-all">WhatsApp</button>
            ${isPontoMarcado ? 
              `<button onclick="deletarPonto(${id})" class="bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded transition-all">Excluir</button>` : 
              ''
            }
          </div>
        `;
        // --- Fim da l√≥gica de Popup ---

        const marker = L.marker([latitude, longitude], { icon: markerIcon }).addTo(map).bindPopup(texto);
        window.markers.push(marker);
        
        // --- Popula a nova tabela "Pontos no Mapa" ---
        if (listaTodosPontosEl) {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-100 hover:bg-indigo-50 cursor-pointer';
            tr.innerHTML = `<td class="p-3 text-gray-700 font-medium">${nome}</td>`;
            
            // Adiciona o clique para pan/zoom no marcador
            tr.onclick = () => {
                map.setView(marker.getLatLng(), 16); // Zoom 16
                marker.openPopup();
                closeAllDropdowns(); // Fecha o menu dropdown
            };
            listaTodosPontosEl.appendChild(tr);
        }
        
        // A lista lateral (Celulares Cadastrados) s√≥ mostrar√° itens que s√£o celulares (que t√™m n√∫mero)
        if (numero) {
            const item = document.createElement('li');
            item.className = 'px-3 py-2 bg-indigo-50 rounded-lg shadow border-l-4 border-indigo-500 text-sm font-medium flex items-center justify-between gap-2';
            
            // innerHTML da lista de celulares modificado para incluir bot√£o "Trajeto"
            item.innerHTML = `
              <div class="flex-1 min-w-0">
                <span class="font-bold">${nome}</span>
                <a href="tel:${numero}" class="block text-indigo-700 underline text-xs" title="Ligar">${numero}</a>
                <span class="text-xs text-gray-500 font-normal">${created_at ? new Date(created_at).toLocaleString('pt-BR') : ''}</span>
              </div>
              <div class="flex flex-col gap-1 items-end">
                <button class="verHistoricoBtn bg-blue-500 hover:bg-blue-600 text-white font-bold text-xs py-1 px-2 rounded shadow w-full text-center" data-id="${id}" data-nome="${nome.replace(/'/g, "\\'")}">Trajeto</button>
                <div class="flex gap-1">
                  <button class="editarBtn bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-1 px-2 rounded shadow" data-id="${id}">Editar</button>
                  <button class="deletarBtn bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded shadow" data-id="${id}">Excluir</button>
                </div>
              </div>
            `;
            
            document.getElementById('listaCelulares').appendChild(item);
        }
      });
      
      if (listaTodosPontosEl && lista.length === 0) {
          listaTodosPontosEl.innerHTML = '<tr><td class="p-3 text-gray-500">Nenhum ponto cadastrado.</td></tr>';
      }

      if (window.markers && window.markers.length > 0) {
        const marker = window.markers[window.markers.length - 1]; // Foca no √∫ltimo item adicionado
        map.setView(marker.getLatLng(), 14);
      }
      setupEventListeners();
    }

    // --- FUN√á√ÉO AUXILIAR PARA ABRIR O MENU DE CADASTRO (Modificada) ---
    function abrirMenuCadastro(isEdicao = false) {
      const titulo = document.getElementById('tituloMenuCadastro');
      openDropdown('menuCadastroContainer', 'menuCadastroChevron'); // <-- MUDAN√áA
      
      if(isEdicao) {
        titulo.textContent = 'Editar Celular';
      } else {
        titulo.textContent = 'Cadastrar Novo Celular';
      }
    }

    // --- FUN√á√ÉO AUXILIAR PARA FECHAR O MENU DE CADASTRO (Modificada) ---
    function fecharMenuCadastro() {
      const titulo = document.getElementById('tituloMenuCadastro');
      closeAllDropdowns(); // <-- MUDAN√áA
      titulo.textContent = 'Cadastrar Novo Celular';
    }

    // ================== FUN√á√ÉO DE HIST√ìRICO TOTALMENTE ATUALIZADA ==================
    async function buscarHistorico(usuarioId, nomeUsuario, dataSelecionada) {
        const historicoStatus = document.getElementById('historicoStatus');
        const historicoTabela = document.getElementById('historicoTabela');
        const historicoLista = document.getElementById('historicoLista');
        const historicoTotalKmEl = document.getElementById('historicoTotalKm'); 
        
        if (!dataSelecionada) {
            historicoStatus.textContent = "Por favor, selecione uma data.";
            return;
        }

        historicoStatus.textContent = `Calculando trajeto de ${nomeUsuario} para ${dataSelecionada}...`;
        historicoStatus.classList.remove('hidden');
        historicoTabela.classList.add('hidden');
        historicoLista.innerHTML = '';
        historicoTotalKmEl.classList.add('hidden'); 
        historicoTotalKmEl.textContent = '';        

        // Limpa o trajeto anterior do mapa
        if (polylineLayer) {
            map.removeLayer(polylineLayer);
            polylineLayer = null;
        }

        // CORRE√á√ÉO: Monta as strings de data/hora diretamente em UTC.
        const inicioDoDiaISO = `${dataSelecionada}T00:00:00.000Z`;
        const fimDoDiaISO = `${dataSelecionada}T23:59:59.999Z`;

        // Busca no Supabase filtrando pelo ID e pelo intervalo de data
        const { data, error } = await supabase
            .from('historico_localizacao')
            .select('latitude, longitude, created_at')
            .eq('usuario_id', usuarioId)
            .gte('created_at', inicioDoDiaISO) 
            .lte('created_at', fimDoDiaISO)   
            .order('created_at', { ascending: true }); 

        if (error) {
            historicoStatus.textContent = `Erro ao buscar hist√≥rico: ${error.message}`;
            return;
        }

        if (data.length < 2) {
            historicoStatus.textContent = `N√£o h√° pontos suficientes (m√≠n. 2) para ${nomeUsuario} neste dia.`;
            return;
        }
        
        // Preenche a tabela de hist√≥rico (mais recente primeiro)
        data.slice().reverse().forEach(ponto => {
            const item = document.createElement('tr');
            item.className = 'border-b border-indigo-100 hover:bg-indigo-200';
            item.innerHTML = `
                <td class="p-1">${new Date(ponto.created_at).toLocaleString('pt-BR')}</td>
                <td class="p-1 text-xs">${ponto.latitude.toFixed(4)}, ${ponto.longitude.toFixed(4)}</td>
            `;
            historicoLista.appendChild(item);
        });
        historicoTabela.classList.remove('hidden');

		const primeiroHorario = new Date(data[0].created_at).toLocaleTimeString('pt-BR');
		const ultimoHorario = new Date(data[data.length - 1].created_at).toLocaleTimeString('pt-BR');

		// Filtra os dados para remover pontos duplicados CONSECUTIVOS.
		const pontosUnicos = data.filter((ponto, index) => {
		    if (index === 0) return true;
		    const pontoAnterior = data[index - 1];
		    return ponto.latitude !== pontoAnterior.latitude || ponto.longitude !== pontoAnterior.longitude;
		});
		
		if (pontosUnicos.length < 2) {
            // Se n√£o houver pontos √∫nicos, joga para o 'catch'
		    throw new Error("N√£o h√° pontos √∫nicos suficientes para a API de rotas.");
		}
		
        // ================== L√ìGICA DE SOMAT√ìRIO (KM RODADO) ==================
		try {
            let distanciaTotalMetros = 0;
            let todasAsLinhas = []; // Guarda todos os segmentos de rota para desenhar no mapa

            // Loop de 1 em 1 nos pontos √∫nicos, pulando o √∫ltimo
            for (let i = 0; i < pontosUnicos.length - 1; i++) {
                const p1 = pontosUnicos[i];
                const p2 = pontosUnicos[i+1];

                const waypointPair = `${p1.latitude},${p1.longitude}|${p2.latitude},${p2.longitude}`;
                const routeUrl = `https://api.geoapify.com/v1/routing?waypoints=${waypointPair}&mode=drive&apiKey=${apiKey}`;

                // Atualiza o status para o usu√°rio saber que est√° processando
                historicoStatus.textContent = `Calculando KM rodado... (${i + 1} de ${pontosUnicos.length - 1})`;
                
                let distanciaSegmento = 0;
                let linhaSegmento = [];

                try {
                    const response = await fetch(routeUrl);
                    const routeData = await response.json();

                    if (routeData.features && routeData.features.length > 0) {
                        // SUCESSO: Pega a dist√¢ncia da ROTA (ruas)
                        distanciaSegmento = routeData.features[0].properties.distance;
                        // Pega a linha da ROTA
                        linhaSegmento = routeData.features[0].geometry.coordinates[0].map(p => [p[1], p[0]]); // Converte [lng, lat] para [lat, lng]
                    } else {
                        // FALHA (API): Usa dist√¢ncia em LINHA RETA para este segmento
                        throw new Error("Segmento da API falhou, usando linha reta.");
                    }
                } catch (segmentError) {
                    // FALHA (API OU REDE): Usa dist√¢ncia em LINHA RETA para este segmento
                    console.warn("Falha no segmento da rota:", segmentError.message);
                    const p1_leaflet = L.latLng(p1.latitude, p1.longitude);
                    const p2_leaflet = L.latLng(p2.latitude, p2.longitude);
                    distanciaSegmento = p1_leaflet.distanceTo(p2_leaflet);
                    // Pega a linha RETA
                    linhaSegmento = [[p1.latitude, p1.longitude], [p2.latitude, p2.longitude]];
                }

                distanciaTotalMetros += distanciaSegmento;
                todasAsLinhas.push(...linhaSegmento); // Adiciona os pontos do segmento √† linha total
            }

            // ---- FIM DO LOOP ----

            const distanciaTotalKm = (distanciaTotalMetros / 1000).toFixed(2);

            // Desenha a rota COMPLETA no mapa
            polylineLayer = L.polyline(todasAsLinhas, { color: '#32CD32', weight: 5, opacity: 0.8 }).addTo(map);
            map.fitBounds(polylineLayer.getBounds()); // Ajusta o zoom

            // Atualiza o status (SEM o KM)
            historicoStatus.textContent = `Trajeto: ${primeiroHorario} √†s ${ultimoHorario}`;
            
            // Preenche o novo campo de KM (C√°lculo de Rota)
            historicoTotalKmEl.textContent = `Total (KM Rodado): ${distanciaTotalKm} km`;
            historicoTotalKmEl.classList.remove('hidden');
        
        } catch (err) {
            // ================== BLOCO CATCH (FALLBACK TOTAL) ==================
			console.error("Erro GERAL ao calcular rota:", err);
		
			if (err.message === "N√£o h√° pontos √∫nicos suficientes para a API de rotas.") {
			    historicoStatus.textContent = `Trajeto: ${primeiroHorario} √†s ${ultimoHorario} (Sem movimento)`;
			} else {
			    historicoStatus.textContent = `Trajeto: ${primeiroHorario} √†s ${ultimoHorario} (C√°lculo de KM falhou)`;
			}

            // Fallback: Calcula o somat√≥rio total em LINHA RETA
            let totalDistanciaMetros = 0;
            // Usar 'data' (a lista completa, n√£o 'pontosUnicos') para o somat√≥rio
            for (let i = 1; i < data.length; i++) { 
                const p1 = L.latLng(data[i-1].latitude, data[i-1].longitude);
                const p2 = L.latLng(data[i].latitude, data[i].longitude);
                totalDistanciaMetros += p1.distanceTo(p2); // distanceTo retorna metros
            }
            const totalDistanciaKm = (totalDistanciaMetros / 1000).toFixed(2);
        
            // Exibe o total de KM (Linha Reta) como fallback
            historicoTotalKmEl.textContent = `Total (Em Linha Reta): ${totalDistanciaKm} km`;
            historicoTotalKmEl.classList.remove('hidden');
		
			// Desenha a linha reta simples
			const latlngs = data.map(p => [p.latitude, p.longitude]);
			polylineLayer = L.polyline(latlngs, { color: '#32CD32', weight: 3, opacity: 0.8, dashArray: '5, 10' }).addTo(map);
			map.fitBounds(polylineLayer.getBounds());
		}
        // ================== FIM DA MUDAN√áA ==================
    }
    // =================== FIM DA FUN√á√ÉO DE HIST√ìRICO ====================

    function setupEventListeners() {
      // ================== LISTENER DO HIST√ìRICO ATUALIZADO ==================
      const verHistoricoBtns = document.querySelectorAll('.verHistoricoBtn');
      // =================== FIM DA MODIFICA√á√ÉO ====================

      const editarBtns = document.querySelectorAll('.editarBtn');
      const deletarBtns = document.querySelectorAll('.deletarBtn');
      const form = document.getElementById('cadastroForm');
      const submitBtn = document.getElementById('submitBtn');
      const cancelEditBtn = document.getElementById('cancelEditBtn');
      const mensagemCadastro = document.getElementById('mensagemCadastro');
      const editId = document.getElementById('editId');
	      const nomeInput = document.getElementById('nome');
	      const numeroInput = document.getElementById('numero');
	      const iconeMaquinaInput = document.getElementById('icone_maquina'); // Novo
	
      // ================== LISTENER DO HIST√ìRICO ATUALIZADO ==================
      // Adiciona o listener para os novos bot√µes "Trajeto"
      verHistoricoBtns.forEach(btn => {
        btn.onclick = () => {
            const id = btn.getAttribute('data-id');
            const nome = btn.getAttribute('data-nome');
            
            // Pega a data do novo input
            const dataSelecionada = document.getElementById('dataTrajeto').value;
            
            if (!dataSelecionada) {
                alert("Por favor, selecione uma data para ver o trajeto.");
                return;
            }
            
            buscarHistorico(id, nome, dataSelecionada);
        };
      });
      // =================== FIM DA MODIFICA√á√ÉO ====================

	      editarBtns.forEach(btn => {
	        btn.onclick = async () => {
	          const id = btn.getAttribute('data-id');
	          mensagemCadastro.textContent = "Carregando dados...";
            
            // --- ATUALIZADO ---
            // Abre o menu de cadastro ao clicar em "Editar"
            abrirMenuCadastro(true); 

	          const { data, error } = await supabase
	            .from('usuarios_localizacao')
	            .select('*')
	            .eq('id', id)
	            .single();
	          if (error) {
	            mensagemCadastro.textContent = "Erro ao carregar dados: " + error.message;
	            return;
	          }
	          editId.value = data.id;
	          nomeInput.value = data.nome;
		          numeroInput.value = data.numero;
	          iconeMaquinaInput.value = data.icone_maquina || ""; // Novo: Define o √≠cone selecionado
		          submitBtn.textContent = "Salvar";
	          cancelEditBtn.classList.remove('hidden');
	          mensagemCadastro.textContent = "";
	        };
	      });

	      cancelEditBtn.onclick = () => {
		        editId.value = "";
		        nomeInput.value = "";
		        numeroInput.value = "";
		        iconeMaquinaInput.value = ""; // Novo: Limpa o select
		        submitBtn.textContent = "Cadastrar";
            cancelEditBtn.classList.add('hidden');
            mensagemCadastro.textContent = "";

            // --- ATUALIZADO ---
            // Fecha o menu ao cancelar
            fecharMenuCadastro();
      };

      deletarBtns.forEach(btn => {
        btn.onclick = async () => {
          if (!confirm('Tem certeza que deseja excluir este registro?')) return;
          const id = btn.getAttribute('data-id');
          const { error } = await supabase
            .from('usuarios_localizacao')
            .delete()
            .eq('id', id);
          if (error) {
            alert("Erro ao excluir: " + error.message);
            return;
          }
          buscarCelulares();
        };
      });

      form.onsubmit = async (e) => {
        e.preventDefault();
        mensagemCadastro.textContent = "Enviando dados...";
        const id = editId.value;
		        const payload = {
		          nome: nomeInput.value,
		          numero: numeroInput.value,
		          icone_maquina: iconeMaquinaInput.value || null // Novo: Inclui o √≠cone selecionado
		        };
        if (id) {
          const { error } = await supabase
            .from('usuarios_localizacao')
            .update(payload)
            .eq('id', id);
          if (error) {
            mensagemCadastro.textContent = "Erro ao atualizar: " + error.message;
            return;
          }
          mensagemCadastro.textContent = "Dados atualizados com sucesso!";
        } else {
          const { error } = await supabase.from('usuarios_localizacao').insert([payload]);
          if (error) {
            mensagemCadastro.textContent = "Erro ao cadastrar: " + error.message;
            return;
          }
          mensagemCadastro.textContent = "Celular cadastrado com sucesso!";
        }
        form.reset();
        cancelEditBtn.classList.add('hidden');
        submitBtn.textContent = "Cadastrar";
        
        // --- ATUALIZADO ---
        // Fecha o menu ap√≥s o submit
        fecharMenuCadastro();

	      buscarCelulares();
	      };
	    }
	
	    // --- Fun√ß√µes CRUD de √çcones ---
	    async function buscarIcones() {
	      const { data: icones, error } = await supabase
	        .from('icones_maquina') // Ajustado para o nome da tabela do usu√°rio
	        .select('*');
	
	      if (error) {
	        document.getElementById('listaIcones').innerHTML = '<li class="text-red-500">Erro ao buscar √≠cones</li>';
	        return [];
	      }
	
	      const listaIconesEl = document.getElementById('listaIcones');
	      listaIconesEl.innerHTML = '';
	
	      (icones || []).forEach(icone => {
	        const item = document.createElement('li');
	        item.className = 'flex items-center gap-2 p-1 bg-gray-100 rounded shadow text-sm';
            // ================== MUDAN√áA 3: L√≥gica da Lista de √çcones ==================
            // Agora, o `icone.label_icone` √© a URL completa da imagem no Supabase
		        item.innerHTML = `
		          <img src="${icone.label_icone}" class="w-5 h-5" alt="${icone.nome_icone}">
	          <span>${icone.nome_icone}</span>
	          <div class="flex gap-1">
	            <button class="editarIconeBtn bg-yellow-400 hover:bg-yellow-500 text-white font-bold text-xs py-0.5 px-1 rounded shadow" data-id="${icone.id}">E</button>
	            <button class="deletarIconeBtn bg-red-600 hover:bg-red-700 text-white font-bold text-xs py-0.5 px-1 rounded shadow" data-id="${icone.id}">X</button>
	          </div>
	        `;
            // ================== FIM DA MUDAN√áA 3 ==================
	        listaIconesEl.appendChild(item);
	      });
	
	      setupIconeEventListeners(icones);
	      return icones;
	    }
	
	    function setupIconeEventListeners(icones) {
	      const editarIconeBtns = document.querySelectorAll('.editarIconeBtn');
	      const deletarIconeBtns = document.querySelectorAll('.deletarIconeBtn');
	      const form = document.getElementById('cadastroIconeForm');
	      const submitBtn = document.getElementById('submitIconeBtn');
	      const cancelEditBtn = document.getElementById('cancelEditIconeBtn');
	      const formTitulo = document.getElementById('formIconeTitulo');
	      const mensagemCadastro = document.getElementById('mensagemCadastroIcone');
	      const editId = document.getElementById('editIconeId');
	      const nomeInput = document.getElementById('nomeIcone');
	      const urlInput = document.getElementById('urlIcone');
	
	      editarIconeBtns.forEach(btn => {
	        btn.onclick = () => {
	          const id = btn.getAttribute('data-id');
	          const icone = icones.find(i => i.id == id);
	          if (!icone) return;
	
	          editId.value = icone.id;
	          nomeInput.value = icone.nome_icone;
	          urlInput.value = icone.label_icone; // O valor agora √© a URL completa
	          submitBtn.textContent = "Salvar √çcone";
	          cancelEditBtn.classList.remove('hidden');
	          formTitulo.textContent = "Editar √çcone";
	          mensagemCadastro.textContent = "";
	        };
	      });
	
	      cancelEditBtn.onclick = () => {
	        editId.value = "";
	        nomeInput.value = "";
	        urlInput.value = "";
	        submitBtn.textContent = "Cadastrar √çcone";
	        cancelEditBtn.classList.add('hidden');
	        formTitulo.textContent = "Cadastrar Novo √çcone";
	        mensagemCadastro.textContent = "";
	      };
	
	      deletarIconeBtns.forEach(btn => {
	        btn.onclick = async () => {
	          if (!confirm('Tem certeza que deseja excluir este √≠cone? Todos os celulares que o utilizam ficar√£o com o √≠cone padr√£o.')) return;
	          const id = btn.getAttribute('data-id');
	          const { error } = await supabase
	            .from('icones_maquina') // Ajustado para o nome da tabela do usu√°rio
	            .delete()
            .eq('id', id);
	          if (error) {
	            alert("Erro ao excluir: " + error.message);
	            return;
	          }
	          buscarIcones();
	          buscarCelulares(); // Atualiza mapa e select
	        };
	      });
	
	      form.onsubmit = async (e) => {
	        e.preventDefault();
	        mensagemCadastro.textContent = "Enviando dados...";
	        const id = editId.value;
	        const payload = {
	          nome_icone: nomeInput.value,
	          label_icone: urlInput.value // Salva a URL completa
	        };
	        if (id) {
	          const { error } = await supabase
	            .from('icones_maquina') // Ajustado para o nome da tabela do usu√°rio
	            .update(payload)
	            .eq('id', id);
	          if (error) {
	            mensagemCadastro.textContent = "Erro ao atualizar √≠cone: " + error.message;
	            return;
	          }
	          mensagemCadastro.textContent = "√çcone atualizado com sucesso!";
	        } else {
	          const { error } = await supabase.from('icones_maquina').insert([payload]); // Ajustado para o nome da tabela do usu√°rio
	          if (error) {
	            mensagemCadastro.textContent = "Erro ao cadastrar √≠cone: " + error.message;
	            return;
          }
	          mensagemCadastro.textContent = "√çcone cadastrado com sucesso!";
	        }
	        form.reset();
	        cancelEditBtn.classList.add('hidden');
	        submitBtn.textContent = "Cadastrar √çcone";
	        document.getElementById('formIconeTitulo').textContent = "Cadastrar Novo √çcone";
	        
            closeAllDropdowns(); // Fecha o menu de √≠cones ap√≥s o submit
	        
            buscarIcones();
	        carregarIconesParaSelect();
	        buscarCelulares(); // Atualiza mapa
	      };
	    }
	
		    document.getElementById('atualizarBtn').onclick = buscarCelulares;
		    
		    async function carregarIconesParaSelect() {
		      const { data: icones, error } = await supabase
		        .from('icones_maquina')
		        .select('label_icone, nome_icone'); // label_icone agora √© a URL
		
		      if (error) {
		        console.error("Erro ao carregar √≠cones para o select:", error.message);
		        return;
		      }
		
		      const selectEl = document.getElementById('icone_maquina');
		      selectEl.innerHTML = '<option value="">(Padr√£o)</option>'; // Op√ß√£o padr√£o
		
		      (icones || []).forEach(icone => {
		        const option = document.createElement('option');
		        option.value = icone.label_icone; // O valor √© a URL
		        option.textContent = icone.nome_icone; // O texto √© s√≥ o nome amig√°vel
		        selectEl.appendChild(option);
		      });
		    }

        // --- 1. NOVO: OUVINTE DE CLIQUE PARA ADICIONAR PONTOS ---
        map.on('click', async function(e) {
          const nomeMaquina = prompt("Digite o nome da m√°quina/ponto de interesse:");

          if (nomeMaquina) {
            const { lat, lng } = e.latlng;
            
            // Salva no Supabase (mesma tabela, mas com 'numero' como texto vazio)
            const { error } = await supabase
              .from('usuarios_localizacao')
              .insert([
                { 
                  nome: nomeMaquina, 
                  latitude: lat, 
                  longitude: lng,
                  numero: '' // <--- CORRE√á√ÉO APLICADA AQUI
                }
              ]);

            if (error) {
              alert("Erro ao salvar o ponto: " + error.message);
            } else {
              alert("Ponto salvo com sucesso!");
              buscarCelulares(); // Atualiza o mapa com o novo ponto
            }
          }
        });
        
        // ================== INICIALIZA√á√ÉO DOS LISTENERS DOS MENUS ==================
        
        // --- OUVINTE PARA MENU DE √çCONES ---
        document.getElementById('toggleIconesMenuBtn').onclick = function() {
            toggleDropdown('menuIconesContainer', 'menuIconeChevron');
        };

        // --- OUVINTE PARA MENU DE CADASTRO DE CELULAR ---
        document.getElementById('toggleCadastroMenuBtn').onclick = function() {
            const isHidden = document.getElementById('menuCadastroContainer').classList.contains('hidden');
            // Se estiver editando (aberto por 'editarBtn'), n√£o reseta o t√≠tulo
            if (isHidden) {
                document.getElementById('tituloMenuCadastro').textContent = 'Cadastrar Novo Celular';
            }
            toggleDropdown('menuCadastroContainer', 'menuCadastroChevron'); 
        };

        // --- OUVINTE PARA MENU PONTOS NO MAPA ---
        document.getElementById('togglePontosMenuBtn').onclick = function() {
            toggleDropdown('menuPontosContainer', 'menuPontosChevron');
        };
        // ================== FIM DOS LISTENERS DOS MENUS ==================


        // ================== INICIALIZA√á√ÉO ==================
        
        // Define o valor do input de data para "hoje" por padr√£o
        document.getElementById('dataTrajeto').valueAsDate = new Date();

		    buscarIcones(); // Adiciona a chamada para buscar √≠cones na inicializa√ß√£o
		    carregarIconesParaSelect(); // Carrega os √≠cones no select
		    buscarCelulares(); // Carrega os celulares e pontos no mapa

		  </script>
</body>
</html>

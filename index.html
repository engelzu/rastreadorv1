<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Painel de Localização dos Celulares</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 500px; }
    .leaflet-popup-content-wrapper { border-radius: 0.75rem; }
    .leaflet-popup-content { font-size: 1rem; }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-700 via-purple-700 to-violet-800 min-h-screen">
  <nav class="bg-white/90 shadow-lg mb-5 flex items-center justify-between px-6 py-3">
    <span class="text-indigo-700 font-bold text-xl">Painel de Geolocalização</span>
  </nav>

  <main class="max-w-5xl mx-auto px-4">
    <section class="mb-7 flex flex-col md:flex-row gap-4 items-center justify-between">
      <h1 class="text-3xl md:text-4xl font-extrabold text-white mb-3 md:mb-0 drop-shadow-lg">
        Localização dos Celulares
      </h1>
      <button id="atualizarBtn"
        class="bg-white hover:bg-indigo-100 text-indigo-700 font-bold py-2 px-5 rounded-lg shadow transition-all">
        Atualizar Dados
      </button>
    </section>
    <div class="bg-white/90 rounded-2xl shadow-lg p-2 mb-4 flex flex-col md:flex-row gap-5">
      <!-- Mapa -->
      <div class="flex-1 min-w-0">
        <div id="map" class="rounded-2xl overflow-hidden shadow-lg"></div>
      </div>
      <!-- Coluna lateral (Lista + Cadastro)-->
      <div class="md:w-96 flex flex-col gap-5 justify-between">
        <div>
          <h2 class="text-xl text-indigo-700 font-bold mb-2">Celulares cadastrados</h2>
          <ul id="listaCelulares" class="flex-1 space-y-2"></ul>
        </div>
        <!-- Formulário cadastral inline -->
        <div class="bg-white rounded-xl shadow px-4 py-3">
          <h2 id="formTitulo" class="text-lg font-bold text-indigo-700 mb-2">Cadastrar novo celular</h2>
          <form id="cadastroForm" class="flex flex-col gap-3">
            <input type="hidden" id="editId" name="editId" />
            <div>
              <label for="nome" class="block text-xs font-semibold text-gray-700 mb-1">Nome:</label>
              <input type="text" id="nome" name="nome" required class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            </div>
            <div>
              <label for="numero" class="block text-xs font-semibold text-gray-700 mb-1">Número do celular:</label>
              <input type="text" id="numero" name="numero" required class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            </div>
            <button type="submit" class="bg-indigo-700 text-white font-bold py-1 px-4 rounded shadow hover:bg-indigo-800 transition" id="submitBtn">Cadastrar</button>
            <button type="button" class="bg-gray-500 text-white font-bold py-1 px-4 rounded shadow hover:bg-gray-600 transition hidden" id="cancelEditBtn">Cancelar</button>
            <p id="mensagemCadastro" class="mt-1 text-xs"></p>
          </form>
        </div>
      </div>
    </div>
    <footer class="mt-8 text-white/70 text-center">Painel - SupabaseDB &copy; 2025</footer>
  </main>

  <!-- Bibliotecas externas ao FINAL -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Seu JS -->
  <script>
    // Troque pelos seus dados!
    const SUPABASE_URL = 'https://rptxfjlxymfmxucctuhc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwdHhmamx4eW1mbXh1Y2N0dWhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NTcxNjMsImV4cCI6MjA3NzEzMzE2M30.kQSF0jp_-0Qi2AmHQNKz6eTo7zeEi3b7Lk9UjT216dU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const apiKey = "9452fa947c234c90b794bf2d1b8c5eb4"; // Geoapify para Leaflet
    const map = L.map('map').setView([-14.2, -51.9], 4);

    L.tileLayer(`https://maps.geoapify.com/v1/tile/osm-liberty/{z}/{x}/{y}.png?apiKey=${apiKey}`, {
      attribution: '© OpenStreetMap, Geoapify',
      maxZoom: 19,
    }).addTo(map);

    async function buscarCelulares() {
      const { data: lista, error } = await supabase
        .from('usuarios_localizacao')
        .select('*');
      if (error) {
        document.getElementById('listaCelulares').innerHTML = '<li class="text-red-500">Erro ao buscar dados</li>';
        return;
      }

      if (window.markers) window.markers.forEach(m => map.removeLayer(m));
      window.markers = [];
      document.getElementById('listaCelulares').innerHTML = '';

      (lista || []).filter(c => c.latitude && c.longitude).forEach(({ id, nome, numero, latitude, longitude, created_at }) => {
        const markerIcon = L.icon({
          iconUrl: `https://api.geoapify.com/v1/icon/?type=awesome&color=%23631fc9&size=large&icon=mobile-alt&apiKey=${apiKey}`,
          iconSize: [38, 58],
          iconAnchor: [19, 56],
          popupAnchor: [0, -50],
        });

        const texto = `
          <div class="text-indigo-700 font-bold text-lg mb-1">${nome}</div>
          <div class="font-medium text-gray-600">Celular: <span>${numero}</span></div>
          <div class="text-xs text-gray-600 mt-1">Registrado: ${created_at ? new Date(created_at).toLocaleString() : '---'}</div>
          <div class="text-xs text-gray-600">Latitude: ${latitude?.toFixed(6)}, Longitude: ${longitude?.toFixed(6)}</div>
        `;

        const marker = L.marker([latitude, longitude], { icon: markerIcon }).addTo(map).bindPopup(texto);
        window.markers.push(marker);

        const item = document.createElement('li');
        item.className = 'px-3 py-2 bg-indigo-50 rounded-lg shadow border-l-4 border-indigo-500 text-sm font-medium flex items-center justify-between gap-2';
        item.innerHTML = `
          <span>${nome}</span>
          <a href="tel:${numero}" class="text-indigo-700 underline" title="Ligar">${numero}</a>
          <span class="text-xs text-gray-500 font-normal">${created_at ? new Date(created_at).toLocaleString() : ''}</span>
          <div class="flex gap-2">
            <button class="editarBtn bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-1 px-2 rounded shadow" data-id="${id}">Editar</button>
            <button class="deletarBtn bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded shadow" data-id="${id}">Excluir</button>
          </div>
        `;
        document.getElementById('listaCelulares').appendChild(item);
      });

      if (window.markers && window.markers.length > 0) {
        const marker = window.markers[0];
        map.setView(marker.getLatLng(), 14);
      }
      setupEventListeners();
    }

    function setupEventListeners() {
      const editarBtns = document.querySelectorAll('.editarBtn');
      const deletarBtns = document.querySelectorAll('.deletarBtn');
      const form = document.getElementById('cadastroForm');
      const submitBtn = document.getElementById('submitBtn');
      const cancelEditBtn = document.getElementById('cancelEditBtn');
      const formTitulo = document.getElementById('formTitulo');
      const mensagemCadastro = document.getElementById('mensagemCadastro');
      const editId = document.getElementById('editId');
      const nomeInput = document.getElementById('nome');
      const numeroInput = document.getElementById('numero');

      editarBtns.forEach(btn => {
        btn.onclick = async () => {
          const id = btn.getAttribute('data-id');
          mensagemCadastro.textContent = "Carregando dados...";
          const { data, error } = await supabase
            .from('usuarios_localizacao')
            .select('*')
            .eq('id', id)
            .single();
          if (error) {
            mensagemCadastro.textContent = "Erro ao carregar dados: " + error.message;
            return;
          }
          editId.value = data.id;
          nomeInput.value = data.nome;
          numeroInput.value = data.numero;
          submitBtn.textContent = "Salvar";
          cancelEditBtn.classList.remove('hidden');
          formTitulo.textContent = "Editar celular";
          mensagemCadastro.textContent = "";
        };
      });

      cancelEditBtn.onclick = () => {
        editId.value = "";
        nomeInput.value = "";
        numeroInput.value = "";
        submitBtn.textContent = "Cadastrar";
        cancelEditBtn.classList.add('hidden');
        formTitulo.textContent = "Cadastrar novo celular";
        mensagemCadastro.textContent = "";
      };

      deletarBtns.forEach(btn => {
        btn.onclick = async () => {
          if (!confirm('Tem certeza que deseja excluir este registro?')) return;
          const id = btn.getAttribute('data-id');
          const { error } = await supabase
            .from('usuarios_localizacao')
            .delete()
            .eq('id', id);
          if (error) {
            alert("Erro ao excluir: " + error.message);
            return;
          }
          buscarCelulares();
        };
      });

      form.onsubmit = async (e) => {
        e.preventDefault();
        mensagemCadastro.textContent = "Enviando dados...";
        const id = editId.value;
        const payload = {
          nome: nomeInput.value,
          numero: numeroInput.value
        };
        if (id) {
          const { error } = await supabase
            .from('usuarios_localizacao')
            .update(payload)
            .eq('id', id);
          if (error) {
            mensagemCadastro.textContent = "Erro ao atualizar: " + error.message;
            return;
          }
          mensagemCadastro.textContent = "Dados atualizados com sucesso!";
        } else {
          const { error } = await supabase.from('usuarios_localizacao').insert([payload]);
          if (error) {
            mensagemCadastro.textContent = "Erro ao cadastrar: " + error.message;
            return;
          }
          mensagemCadastro.textContent = "Celular cadastrado com sucesso!";
        }
        form.reset();
        cancelEditBtn.classList.add('hidden');
        submitBtn.textContent = "Cadastrar";
        document.getElementById('formTitulo').textContent = "Cadastrar novo celular";
        buscarCelulares();
      };
    }

    document.getElementById('atualizarBtn').onclick = buscarCelulares;
    buscarCelulares();
  </script>
</body>
</html>

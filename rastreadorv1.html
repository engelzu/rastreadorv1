<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Localiza√ß√£o do Meu Celular</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { min-height: 100vh; }
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    .status-active { background-color: #10b981; box-shadow: 0 0 8px #10b981; }
    .status-inactive { background-color: #ef4444; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-700 via-purple-700 to-violet-800 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-md rounded-2xl shadow-2xl bg-white/95 mx-auto p-6 mt-5 mb-6">
    <h1 class="text-2xl font-extrabold text-indigo-700 mb-4 text-center drop-shadow">üó∫Ô∏è Autoriza√ß√£o e Envio de Localiza√ß√£o</h1>
    
    <!-- Status do Rastreamento -->
    <div id="statusContainer" class="mb-4 p-4 rounded-xl border-2 border-gray-200 bg-gray-50">
      <div class="flex items-center justify-between mb-2">
        <span class="font-bold text-gray-700">Status:</span>
        <div id="statusIndicator" class="flex items-center">
          <span class="status-indicator status-inactive"></span>
          <span id="statusText" class="text-sm font-medium text-gray-600">Inativo</span>
        </div>
      </div>
      <div class="text-xs text-gray-500">
        <div>Intervalo: <span class="font-semibold">5 minutos</span></div>
        <div>√öltimo envio: <span id="ultimoEnvio" class="font-semibold">Nunca</span></div>
        <div>Pr√≥ximo envio: <span id="proximoEnvio" class="font-semibold">---</span></div>
        <div>Envios realizados: <span id="contagemEnvios" class="font-semibold">0</span></div>
      </div>
    </div>

    <form id="enviarLocalizacaoForm" class="flex flex-col gap-5">
      <div>
        <label for="celularSelect" class="block text-indigo-700 font-semibold mb-1 text-sm">Selecione seu celular:</label>
        <select id="celularSelect" required class="w-full px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 text-base shadow">
          <option value="">Carregando...</option>
        </select>
        <!-- Mensagem de status de carregamento -->
        <div id="loadingMsg" class="mt-2 text-xs text-gray-500"></div>
      </div>
      
      <button
        type="button"
        id="liberarBtn"
        class="w-full bg-gradient-to-tr from-purple-600 to-indigo-700 text-white font-bold rounded-xl py-3 shadow-xl text-lg hover:scale-105 transition active:scale-95"
      >
        üöÄ Iniciar Rastreamento
      </button>
      
      <button
        type="button"
        id="pararBtn"
        class="w-full bg-gradient-to-tr from-red-600 to-red-700 text-white font-bold rounded-xl py-3 shadow-xl text-lg hover:scale-105 transition active:scale-95 hidden"
      >
        ‚èπÔ∏è Parar Rastreamento
      </button>
      
      <div id="statusMsg" class="mt-2 text-center text-sm font-medium"></div>
    </form>

    <!-- Informa√ß√µes sobre Wake Lock -->
    <div id="wakeLockInfo" class="mt-4 p-3 rounded-lg bg-blue-50 border border-blue-200 text-xs text-blue-800 hidden">
      <p class="font-semibold mb-1">üîã Wake Lock Ativado</p>
      <p>O app continuar√° rastreando mesmo com a tela desligada ou minimizada.</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL = 'https://rptxfjlxymfmxucctuhc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwdHhmamx4eW1mbXh1Y2N0dWhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NTcxNjMsImV4cCI6MjA3NzEzMzE2M30.kQSF0jp_-0Qi2AmHQNKz6eTo7zeEi3b7Lk9UjT216dU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const INTERVALO_MS = 5 * 60 * 1000;
    let intervaloLocalizacao = null;
    let wakeLock = null;
    let contagemEnvios = 0;
    let proximoEnvioTimeout = null;

    const celularSelect = document.getElementById('celularSelect');
    const liberarBtn = document.getElementById('liberarBtn');
    const pararBtn = document.getElementById('pararBtn');
    const statusMsg = document.getElementById('statusMsg');
    const loadingMsg = document.getElementById('loadingMsg');
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const ultimoEnvioEl = document.getElementById('ultimoEnvio');
    const proximoEnvioEl = document.getElementById('proximoEnvio');
    const contagemEnviosEl = document.getElementById('contagemEnvios');
    const wakeLockInfo = document.getElementById('wakeLockInfo');

    async function solicitarPermissaoNotificacao() {
      if ('Notification' in window && Notification.permission === 'default') {
        const permission = await Notification.requestPermission();
        console.log('Permiss√£o de notifica√ß√£o:', permission);
      }
    }

    function enviarNotificacao(titulo, mensagem) {
      if ('Notification' in window && Notification.permission === 'granted') {
        try {
          new Notification(titulo, {
            body: mensagem,
            icon: '/icon-192x192.png',
            badge: '/icon-192x192.png',
            tag: 'rastreamento-gps'
          });
        } catch (err) {
          console.log('Erro ao enviar notifica√ß√£o:', err);
        }
      }
    }

    async function requisitarWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLockInfo.classList.remove('hidden');
          console.log('‚úÖ Wake Lock ativado');
          
          wakeLock.addEventListener('release', () => {
            console.log('‚ö†Ô∏è Wake Lock liberado');
            wakeLockInfo.classList.add('hidden');
          });
        } else {
          console.log('‚ö†Ô∏è Wake Lock n√£o suportado');
        }
      } catch (err) {
        console.log('‚ùå Wake Lock negado:', err);
      }
    }

    async function liberarWakeLock() {
      if (wakeLock !== null) {
        try {
          await wakeLock.release();
          wakeLock = null;
          wakeLockInfo.classList.add('hidden');
        } catch (err) {
          console.error('Erro ao liberar Wake Lock:', err);
        }
      }
    }

    function atualizarStatusUI(ativo) {
      if (ativo) {
        statusIndicator.innerHTML = '<span class="status-indicator status-active pulse"></span>';
        statusText.textContent = 'Rastreando';
        statusText.className = 'text-sm font-medium text-green-600';
        liberarBtn.classList.add('hidden');
        pararBtn.classList.remove('hidden');
      } else {
        statusIndicator.innerHTML = '<span class="status-indicator status-inactive"></span>';
        statusText.textContent = 'Inativo';
        statusText.className = 'text-sm font-medium text-gray-600';
        liberarBtn.classList.remove('hidden');
        pararBtn.classList.add('hidden');
        proximoEnvioEl.textContent = '---';
      }
    }

    function atualizarContagemRegressiva() {
      if (proximoEnvioTimeout) {
        clearInterval(proximoEnvioTimeout);
        proximoEnvioTimeout = null;
      }

      const inicioContagem = Date.now();
      const fimContagem = inicioContagem + INTERVALO_MS;

      proximoEnvioTimeout = setInterval(() => {
        const agora = Date.now();
        const restante = fimContagem - agora;

        if (restante <= 0) {
          proximoEnvioEl.textContent = 'Enviando...';
          return;
        }

        const minutos = Math.floor(restante / 60000);
        const segundos = Math.floor((restante % 60000) / 1000);
        proximoEnvioEl.textContent = minutos + 'm ' + segundos + 's';
      }, 1000);
    }

    async function carregarCelulares() {
      try {
        loadingMsg.textContent = 'üîÑ Carregando celulares...';
        loadingMsg.className = 'mt-2 text-xs text-blue-600';
        
        const { data: lista, error } = await supabase
          .from('usuarios_localizacao')
          .select('id,nome,numero');
        
        if (error) throw error;

        celularSelect.innerHTML = '<option value="">Selecione...</option>';
        
        if (lista && lista.length > 0) {
          lista.forEach(c => {
            celularSelect.innerHTML += '<option value="' + c.id + '">' + c.nome + ' (' + c.numero + ')</option>';
          });
          loadingMsg.textContent = '‚úÖ ' + lista.length + ' celular(es) carregado(s)';
          loadingMsg.className = 'mt-2 text-xs text-green-600';
        } else {
          loadingMsg.textContent = '‚ö†Ô∏è Nenhum celular cadastrado';
          loadingMsg.className = 'mt-2 text-xs text-orange-600';
        }
        
        const savedId = localStorage.getItem('lastSelectedCelularId');
        if (savedId) {
          celularSelect.value = savedId;
          console.log('Celular restaurado:', savedId);
        }

        const rastreamentoAtivo = localStorage.getItem('rastreamentoAtivo');
        const contagemSalva = localStorage.getItem('contagemEnvios');
        
        if (contagemSalva) {
          contagemEnvios = parseInt(contagemSalva, 10);
          contagemEnviosEl.textContent = contagemEnvios;
        }

        if (rastreamentoAtivo === 'true' && savedId) {
          console.log('üîÑ Restaurando rastreamento...');
          setTimeout(() => iniciarRastreamento(), 1000);
        }
      } catch (err) {
        console.error('Erro ao carregar:', err);
        loadingMsg.textContent = '‚ùå Erro: ' + err.message;
        loadingMsg.className = 'mt-2 text-xs text-red-600';
        celularSelect.innerHTML = '<option value="">Erro ao carregar</option>';
      }
    }
    
    async function obterEEnviarLocalizacao(celularId) {
      if (!celularId) {
        statusMsg.textContent = "‚ùå Selecione o celular!";
        statusMsg.className = 'mt-2 text-center text-sm font-medium text-red-600';
        return false;
      }
      
      if (!navigator.geolocation) {
        statusMsg.textContent = "‚ùå Geolocaliza√ß√£o n√£o suportada";
        statusMsg.className = 'mt-2 text-center text-sm font-medium text-red-600';
        return false;
      }
      
      statusMsg.textContent = "üìç Obtendo localiza√ß√£o...";
      statusMsg.className = 'mt-2 text-center text-sm font-medium text-blue-600';
      console.log('üìç Solicitando localiza√ß√£o...');
      
      try {
        const posicao = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
          });
        });

        console.log('‚úÖ Localiza√ß√£o:', posicao.coords.latitude, posicao.coords.longitude);
        statusMsg.textContent = "üì§ Enviando...";
        
        const { error } = await supabase
          .from('usuarios_localizacao')
          .update({
            latitude: posicao.coords.latitude,
            longitude: posicao.coords.longitude,
            created_at: new Date().toISOString()
          })
          .eq('id', celularId);

        if (error) throw error;

        contagemEnvios++;
        localStorage.setItem('contagemEnvios', contagemEnvios);
        contagemEnviosEl.textContent = contagemEnvios;
        
        const horario = new Date().toLocaleTimeString('pt-BR');
        ultimoEnvioEl.textContent = horario;
        statusMsg.textContent = '‚úÖ Enviado √†s ' + horario;
        statusMsg.className = 'mt-2 text-center text-sm font-medium text-green-600';
        
        console.log('‚úÖ Envio #' + contagemEnvios + ' √†s ' + horario);
        enviarNotificacao('Localiza√ß√£o Enviada', 'Envio #' + contagemEnvios + ' - ' + horario);
        
        atualizarContagemRegressiva();
        return true;
      } catch (erro) {
        console.error('‚ùå Erro:', erro);
        const msg = erro.code === 1 ? 'Permiss√£o negada' : 
                   erro.code === 2 ? 'Indispon√≠vel' :
                   erro.code === 3 ? 'Tempo esgotado' :
                   erro.message || 'Erro desconhecido';
        
        statusMsg.textContent = "‚ùå " + msg;
        statusMsg.className = 'mt-2 text-center text-sm font-medium text-red-600';
        enviarNotificacao('Erro', msg);
        return false;
      }
    }
    
    async function iniciarRastreamento() {
      const celularId = celularSelect.value;
      
      if (!celularId) {
        statusMsg.textContent = "‚ùå Selecione um celular";
        statusMsg.className = 'mt-2 text-center text-sm font-medium text-red-600';
        return;
      }

      console.log('üöÄ Iniciando rastreamento:', celularId);

      if (intervaloLocalizacao) {
        console.log('‚ö†Ô∏è Parando rastreamento anterior...');
        clearInterval(intervaloLocalizacao);
        intervaloLocalizacao = null;
      }

      if (proximoEnvioTimeout) {
        clearInterval(proximoEnvioTimeout);
        proximoEnvioTimeout = null;
      }

      await solicitarPermissaoNotificacao();
      await requisitarWakeLock();
      
      localStorage.setItem('rastreamentoAtivo', 'true');
      localStorage.setItem('lastSelectedCelularId', celularId);
      
      atualizarStatusUI(true);
      statusMsg.textContent = "üöÄ Iniciando...";
      statusMsg.className = 'mt-2 text-center text-sm font-medium text-blue-600';
      
      console.log('üì§ Primeiro envio imediato...');
      const sucesso = await obterEEnviarLocalizacao(celularId);
      
      if (!sucesso) {
        console.error('‚ùå Falha, abortando');
        pararRastreamento();
        return;
      }

      console.log('‚è∞ Configurando intervalo de ' + (INTERVALO_MS/60000) + ' min');
      intervaloLocalizacao = setInterval(async () => {
        console.log('‚è∞ DISPARO AUTOM√ÅTICO - enviando...');
        await obterEEnviarLocalizacao(celularId);
      }, INTERVALO_MS);

      console.log('‚úÖ Rastreamento ativo! ID:', intervaloLocalizacao);
      enviarNotificacao('Rastreamento Iniciado', 'Envio a cada 5 minutos');
    }
    
    function pararRastreamento() {
      console.log('‚èπÔ∏è Parando...');
      
      if (intervaloLocalizacao) {
        clearInterval(intervaloLocalizacao);
        intervaloLocalizacao = null;
        console.log('‚úÖ Intervalo cancelado');
      }

      if (proximoEnvioTimeout) {
        clearInterval(proximoEnvioTimeout);
        proximoEnvioTimeout = null;
      }

      liberarWakeLock();
      localStorage.setItem('rastreamentoAtivo', 'false');
      atualizarStatusUI(false);
      statusMsg.textContent = "‚èπÔ∏è Rastreamento parado";
      statusMsg.className = 'mt-2 text-center text-sm font-medium text-gray-600';
      
      console.log('‚úÖ Parado');
      enviarNotificacao('Parado', 'Rastreamento interrompido');
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(reg => console.log('‚úÖ SW registrado:', reg.scope))
        .catch(err => console.log('‚ùå Erro SW:', err));
    }

    celularSelect.addEventListener('change', (e) => {
      const id = e.target.value;
      if (id) {
        localStorage.setItem('lastSelectedCelularId', id);
        console.log('Selecionado:', id);
        loadingMsg.textContent = '‚úÖ Celular selecionado';
        loadingMsg.className = 'mt-2 text-xs text-green-600';
      }
    });

    liberarBtn.addEventListener('click', () => {
      console.log('üëÜ Iniciar clicado');
      iniciarRastreamento();
    });

    pararBtn.addEventListener('click', () => {
      console.log('üëÜ Parar clicado');
      pararRastreamento();
    });

    document.addEventListener('visibilitychange', async () => {
      if (document.visibilityState === 'visible') {
        console.log('üëÅÔ∏è App voltou');
        if (wakeLock === null && intervaloLocalizacao) {
          console.log('üîÑ Reativando Wake Lock');
          await requisitarWakeLock();
        }
      } else {
        console.log('üôà App minimizado - intervalo continua');
      }
    });

    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üöÄ App inicializado - Intervalo: ' + (INTERVALO_MS/60000) + ' min');
      await carregarCelulares();
    });

    setInterval(() => {
      if (intervaloLocalizacao) {
        console.log('üíö Rastreamento ativo OK');
      }
    }, 60000);
  </script>
</body>
</html>
